<!DOCTYPE html>
<html lang="ja">
<head>
  	<meta charset="UTF-8">
  	<title>競プロ デバック 視覚化</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	<!-- Bootstrap -->
  	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
	<h1 class="text-center mb-3">競プロ デバック 視覚化</h1>
    <h2 class="mb-3">プログラム入力</h2>
    <form method="post" action="/">        
        <div class="mb-3">
            <label for="code-input" class="form-label">コードをここに入力してください：</label>
            <textarea class="form-control" id="code-input" name="code-input" rows="15">{% if code != None %}{{ code }}{% endif %}</textarea>
        </div>
        <button type="submit" class="btn btn-primary">実行</button>    
    </form>

    {% if all_variables != None%}
        <div class="d-flex justify-content-center mb-3">
            <button id="prev-btn" class="btn btn-primary">&lt; 前</button>
            <button id="next-btn" class="btn btn-primary">次 &gt;</button>

            <select id="step-select" class="form-select mx-2" style="width: auto;">
            {% for i in range(all_variables|length) %}
                <option value="{{ i }}">ステップ {{ i+1 }}</option>
            {% endfor %}
            </select>

            <select id="step-length-select" class="form-select mx-2" style="width: auto;">
            {% for i in range(all_variables|length) %}
                <option value="{{ i+1 }}">同時に表示するステップ数 {{ i+1 }}</option>
            {% endfor %}
            </select>
        </div>
    {% endif %}

    {% if all_variables != None %}
		<div class="table-responsive">
			<h4>変数</h4>
			<table class="table table-bordered table-striped" id="variables-table">
                <thead class="table-light">
                </thead>
                <tbody></tbody>
            </table>
		</div>

		<div class="table-responsive">
			<h4>一次元配列</h4>
			<table class="table table-bordered" id="one-d-array-table">
                <thead>
                </thead>
                <tbody></tbody>
            </table>
		</div>

		<div class="table-responsive">
			<h4>N次元配列</h4>
            <div class="d-flex gap-2 align-items-center">
                <select id="n-d-array-select" class="form-select" style="width: auto;"></select>
                <select id="vertical-axis" class="form-select" style="width: auto;"></select>
                <select id="horizontal-axis" class="form-select" style="width: auto;"></select>
                <div id="fixed-dimension-container" class="d-flex gap-2 align-items-center"></div>
            </div>
            <table class="table table-bordered" id="n-d-array-table">
                <thead>
                </thead>
                <tbody></tbody>
            </table>
		</div>
    {% endif %}


</div>
</body>

<script>
    document.getElementById('code-input').placeholder =
`例：
from atcoder.dsu import DSU

N, Q = map(int, input().split())
uf = DSU(N)
for _ in range(Q):
    t, u, v = map(int, input().split())
    if t == 0:
        uf.merge(u, v)
    else:
        if uf.same(u, v):
            print(1)
        else:
            print(0)`;

{%if all_variables != None %}
    function renderVariablesTableHeader(start_step,last_step) {
        const table_head = document.querySelector("#variables-table thead");
        table_head.innerHTML = "";

        const row = document.createElement("tr");
        
        // 変数名のヘッダー
        const variable_name = document.createElement("th");
        variable_name.textContent = "変数名";
        row.appendChild(variable_name);

        // 値のヘッダーを_display_step_countに合わせて作る
        for(let i = start_step; i < last_step; i++) {
            const value_name = document.createElement("th");
            value_name.textContent = `ステップ ${i + 1}`;
            row.appendChild(value_name);
        }

        table_head.appendChild(row);
    }

    function renderVariablesTable(start_step,last_step) {
        
        const table_body = document.querySelector("#variables-table tbody");
        table_body.innerHTML = "";

        renderVariablesTableHeader(start_step,last_step);

        const step_row = document.createElement("tr");
        const step_cell = document.createElement("td");
        step_cell.colSpan = (last_step - start_step) + 1;
        step_cell.textContent = `ステップ: ${start_step + 1}～${last_step}`;
        step_cell.style.fontWeight = "bold";
        step_row.appendChild(step_cell);
        table_body.appendChild(step_row);

        const union_keys = Array.from(
            new Set(
                _all_variables.slice(start_step, last_step).flatMap(dict => dict["variables"] ? Object.keys(dict["variables"]) : [])
            )
        );

        for(let i=0; i < union_keys.length; i++) {
            const row = document.createElement("tr");
            const variable_name = document.createElement("td");
            variable_name.textContent = union_keys[i];
            row.appendChild(variable_name);

            for(let j=start_step; j < last_step; j++) {
                const value_cell = document.createElement("td");
                if (_all_variables[j]?.["variables"]?.[union_keys[i]] !== undefined) {
                    value_cell.textContent = _all_variables[j]["variables"][union_keys[i]];
                } else {
                    value_cell.textContent = "N/A";
                }
                row.appendChild(value_cell);
            }

            table_body.appendChild(row);
        }
    }

    function renderOneDArrayTableHeader(max_len) {
        const table_head = document.querySelector("#one-d-array-table thead");
        table_head.innerHTML = "";

        const row = document.createElement("tr");
        
        // 変数名のヘッダー
        const variable_name = document.createElement("th");
        variable_name.textContent = "変数名";
        row.appendChild(variable_name);

        // 変数名のヘッダー
        const step_value = document.createElement("th");
        step_value.textContent = "ステップ";
        row.appendChild(step_value);

        // 値のヘッダーを_display_step_countに合わせて作る
        for(let i = 0; i < max_len; i++) {
            const value_name = document.createElement("th");
            value_name.textContent = `idx${i + 1}`;
            row.appendChild(value_name);
        }

        table_head.appendChild(row);
    }

    function renderOneDArray(start_step,last_step) {
        let max_len = 0;
        for (let i = start_step; i < last_step; i++) {
            const obj = _all_variables[i]?.["one_d_array"];
            if (obj) {  // objが存在するときだけ処理
                for (const key in obj) {
                    if (Object.hasOwn(obj, key)) {
                        max_len = Math.max(max_len, obj[key].length);
                    }
                }
            }
        }

        renderOneDArrayTableHeader(max_len);

        const table_body = document.querySelector("#one-d-array-table tbody");
        table_body.innerHTML = "";

        const union_keys = Array.from(
            new Set(
                _all_variables.slice(start_step, last_step).flatMap(dict => dict["one_d_array"] ? Object.keys(dict["one_d_array"]) : [])
            )
        );

        for(let i=0; i < union_keys.length; i++) {
            for(let j=start_step; j < last_step; j++) {
                if (_all_variables[j]?.["one_d_array"]?.[union_keys[i]] === undefined) {
                    continue;
                }
                const row = document.createElement("tr");
                if (i % 2 === 0) {
                    row.classList.add('table-secondary');  // 薄いグレー風
                    row.classList.remove('table-light');
                } else {
                    row.classList.add('table-light');      // 白
                    row.classList.remove('table-secondary');
                }
                const variable_name = document.createElement("td");
                variable_name.textContent = union_keys[i];
                row.appendChild(variable_name);

                const step_name = document.createElement("td");
                step_name.textContent = j+1;
                row.appendChild(step_name);

                for(let k=0;k < _all_variables[j]["one_d_array"][union_keys[i]].length; k++) {
                    const value_cell = document.createElement("td");
                    value_cell.textContent = _all_variables[j]["one_d_array"][union_keys[i]][k];
                    row.appendChild(value_cell);
                }
                for(let k=_all_variables[j]["one_d_array"][union_keys[i]].length;k < max_len; k++) {
                    const value_cell = document.createElement("td");
                    value_cell.textContent = "N/A";
                    value_cell.style.color = "gray";  // N/Aのセルは薄い色にする
                    row.appendChild(value_cell);
                }
                table_body.appendChild(row);
            }
        }
    }

    function getDimension(n_d_array) {
        if(Array.isArray(n_d_array)){
            return getDimension(n_d_array[0])+1;
        }else{
            return 0;
        }
    }

    function getDimensionLength(n_d_array,index) {
        if(index === 0)return n_d_array.length;
        else{
            return getDimensionLength(n_d_array[0],index-1);
        }
    }

    function nDArraySelectFirstSet(start_step,n_d_array_name){
        const n_d_array_select = document.getElementById("n-d-array-select");
        const vertical_axis = document.getElementById("vertical-axis");
        const horizontal_axis = document.getElementById("horizontal-axis");
        const fixed_dimension_container = document.getElementById("fixed-dimension-container");

        _n_d_array_dimension = getDimension(_all_variables[start_step]["n_d_array"][_n_d_array_name],0);

        if(_n_d_array_dimension < 2){
            vertical_axis.disabled = true;
            horizontal_axis.disabled = true;
            return;
        }

        for(let i=0; i < _n_d_array_dimension; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = `次元${i+1}`;
            vertical_axis.appendChild(option);
            horizontal_axis.appendChild(option.cloneNode(true));
            if(_n_d_array_dimension > 2){
                const select = document.createElement("select");
                select.className = "form-select";
                select.style.width = "auto";
                select.id = `fixed-dimension-${i}`;
                const dimension_length = getDimensionLength(_all_variables[start_step]["n_d_array"][_n_d_array_name],i);
                for(let j=0; j < dimension_length; j++) {
                    const option = document.createElement("option");
                    option.value = j;
                    option.textContent = `次元${i+1}idx${j}`;
                    select.appendChild(option);
                }
                fixed_dimension_container.appendChild(select);
            }
        }
        vertical_axis.value = 0;
        horizontal_axis.value = 1;

        _vertical_axis_dimension = vertical_axis.value;
        _horizontal_axis_dimension = horizontal_axis.value;

        _fixed_dimension_index = [];
        _fixed_dimension_index.push(-1);
        _fixed_dimension_index.push(-1);
        for(let j=2; j < _n_d_array_dimension; j++) {
            _fixed_dimension_index.push(0);
        }
        

        if(_n_d_array_dimension > 2){
            document.getElementById(`fixed-dimension-${_vertical_axis_dimension}`).disabled = true;
            document.getElementById(`fixed-dimension-${_horizontal_axis_dimension}`).disabled = true;
        }

        n_d_array_select.disabled = false;
        vertical_axis.disabled = false;
        horizontal_axis.disabled = false;
    }

    function nDArraySelectReset(start_step){
        const n_d_array_select = document.getElementById("n-d-array-select");
        const vertical_axis = document.getElementById("vertical-axis");
        const horizontal_axis = document.getElementById("horizontal-axis");
        const fixed_dimension_container = document.getElementById("fixed-dimension-container");

        n_d_array_select.innerHTML = "";
        vertical_axis.innerHTML = "";
        horizontal_axis.innerHTML = "";
        fixed_dimension_container.innerHTML = "";

        const keys = _all_variables[start_step]?.["n_d_array"] ? Object.keys(_all_variables[start_step]?.["n_d_array"]) : [];
        if(keys.length < 1){
            n_d_array_select.disabled = true;
            vertical_axis.disabled = true;
            horizontal_axis.disabled = true;
            return;
        }

        _n_d_array_name = keys[0];
        for(let i=0; i < keys.length; i++) {
            const option = document.createElement("option");
            option.value = keys[i];
            option.textContent = `変数名:${keys[i]}`;
            n_d_array_select.appendChild(option);
        }

        nDArraySelectFirstSet(start_step,_n_d_array_name);
    }

    
    function changeVerticalAxis(start_step,prev_vertical_axis_dimension,new_vertical_axis_dimension){
        _vertical_axis_dimension = new_vertical_axis_dimension;
        if(prev_vertical_axis_dimension !== _horizontal_axis_dimension){
            _fixed_dimension_index[prev_vertical_axis_dimension] = document.getElementById(`fixed-dimension-${prev_vertical_axis_dimension}`).value;
            if(_n_d_array_dimension > 2)document.getElementById(`fixed-dimension-${prev_vertical_axis_dimension}`).disabled = false;
        }
        _fixed_dimension_index[new_vertical_axis_dimension] = -1;
        if(_n_d_array_dimension > 2)document.getElementById(`fixed-dimension-${new_vertical_axis_dimension}`).disabled = true;
    }

    function changeHorizontalAxis(start_step,prev_horizontal_axis_dimension,new_horizontal_axis_dimension){
        _horizontal_axis_dimension = new_horizontal_axis_dimension;
        if(prev_horizontal_axis_dimension !== _vertical_axis_dimension){
            _fixed_dimension_index[prev_horizontal_axis_dimension] = document.getElementById(`fixed-dimension-${prev_horizontal_axis_dimension}`).value;
            if(_n_d_array_dimension > 2)document.getElementById(`fixed-dimension-${prev_horizontal_axis_dimension}`).disabled = false;
        }
        _fixed_dimension_index[new_horizontal_axis_dimension] = -1;
        if(_n_d_array_dimension > 2)document.getElementById(`fixed-dimension-${new_horizontal_axis_dimension}`).disabled = true;
    }

    function renderNDArray(variable_name, vertical_dimension){

    }

    function renderTable(start_step,last_step){
        if(_all_variables && _all_variables.length !== 0) {
            renderVariablesTable(start_step,last_step);
            renderOneDArray(start_step,last_step);
            
        }
    }

    function selectFirstSet(start_step){
       nDArraySelectReset(start_step);
    }

    document.getElementById("prev-btn").addEventListener("click", prev);
    function prev() {
        if (_current_step > 0) {
            _current_step--;
            selectFirstSet(Math.max(0,_current_step));
            renderTable(Math.max(0,_current_step),Math.min(_current_step+_display_step_count,_all_variables.length));
        }
    }

    document.getElementById("next-btn").addEventListener("click", next);
    function next() {
        if (_current_step < _all_variables.length - 1) {
            _current_step++;
            selectFirstSet(Math.max(0,_current_step));
            renderTable(Math.max(0,_current_step),Math.min(_current_step+_display_step_count,_all_variables.length));
        }
    }

    const _step_select = document.getElementById('step-select');
    _step_select.addEventListener('change', (event) => {
        _current_step = Number(event.target.value);  // 選ばれたoptionのvalueを数値に変換して代入
        selectFirstSet(Math.max(0,_current_step));
        renderTable(Math.max(0,_current_step),Math.min(_current_step+_display_step_count,_all_variables.length));
    });

    const _step_length_select = document.getElementById('step-length-select');
    _step_length_select.addEventListener('change', (event) => {
        _display_step_count = Number(event.target.value);  // 選ばれたoptionのvalueを数値に変換して代入
        renderTable(Math.max(0,_current_step),Math.min(_current_step+_display_step_count,_all_variables.length));
    });
    
    const _all_variables = JSON.parse('{{ all_variables_json|safe }}');
    let _current_step = 0;
    let _display_step_count = 1;

    let _n_d_array_name = "";
    let _n_d_array_dimension = 0;
    let _vertical_axis_dimension = 0;
    let _horizontal_axis_dimension = 0;
    let _fixed_dimension_index = [];

    selectFirstSet(Math.max(0,_current_step));
    renderTable(Math.max(0,_current_step),Math.min(_current_step+_display_step_count,_all_variables.length));
{% endif %}
</script>

</html>
